<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å…·é»å­˜ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#f3f4f6'
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <style>
        /* QR Scanner Styles */
        #qr-video {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 8px;
            display: block;
            margin: 0 auto;
        }
        
        .scanner-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            min-height: 300px;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid #5D5CDE;
            border-radius: 12px;
            pointer-events: none;
            z-index: 10;
        }

        .scanner-overlay::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border: 3px solid rgba(93, 92, 222, 0.3);
            border-radius: 12px;
            animation: scanner-pulse 2s infinite;
        }

        @keyframes scanner-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .camera-instructions {
            text-align: center;
            padding: 20px;
            background: rgba(93, 92, 222, 0.1);
            border-radius: 8px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
    <!-- Main Container -->
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-primary mb-2">ğŸ“‹ æ•™å…·é»å­˜ç³»çµ±</h1>
            <p class="text-gray-600 dark:text-gray-400">æƒæQR codeé€²è¡Œæ•™å…·é»å­˜ç®¡ç†</p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid lg:grid-cols-2 gap-6 mb-8">
            <!-- QR Scanner Section -->
            <section class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold flex items-center">
                        <span class="text-2xl mr-2">ğŸ“±</span>
                        QR Code æƒæ
                    </h2>
                    <button id="switchCameraBtn" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600 hidden">
                        åˆ‡æ›ç›¸æ©Ÿ
                    </button>
                </div>
                
                <!-- Camera Scanner -->
                <div id="cameraSection" class="mb-4">
                    <div class="scanner-container text-center mb-4">
                        <video id="qr-video" class="hidden"></video>
                        <div class="scanner-overlay hidden"></div>
                    </div>
                    <div class="flex justify-center space-x-3">
                        <button id="startCameraBtn" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            ğŸ“· å•Ÿå‹•ç›¸æ©Ÿæƒæ
                        </button>
                        <button id="stopCameraBtn" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors hidden">
                            â¹ï¸ åœæ­¢æƒæ
                        </button>
                    </div>
                </div>

                <!-- Camera Instructions -->
                <div class="camera-instructions" id="cameraInstructions">
                    <div class="text-lg font-medium mb-2">ğŸ“· ä½¿ç”¨èªªæ˜</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        <p>1. é»æ“Šã€Œå•Ÿå‹•ç›¸æ©Ÿæƒæã€é–‹å§‹ä½¿ç”¨</p>
                        <p>2. å°‡æ•™å…·ä¸Šçš„QR codeå°æº–æƒææ¡†</p>
                        <p>3. ç³»çµ±æœƒè‡ªå‹•è­˜åˆ¥ä¸¦è¨˜éŒ„é»å­˜</p>
                    </div>
                </div>

                <!-- Scan Result -->
                <div id="scanResult" class="hidden mt-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
                    <h3 class="font-semibold text-green-800 dark:text-green-400 mb-2">æƒæçµæœï¼š</h3>
                    <p id="scanResultText" class="text-green-700 dark:text-green-300 break-all"></p>
                </div>
            </section>

            <!-- CSV Management Section -->
            <section class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="text-2xl mr-2">ğŸ“„</span>
                    CSV è³‡æ–™ç®¡ç†
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">åŒ¯å…¥æ•™å…·æ¸…å–®</label>
                        <input type="file" id="csvInput" accept=".csv,.xlsx,.xls" 
                               class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">æ”¯æ´æ ¼å¼ï¼šCSVã€Excel (.xlsx/.xls)</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">æ ¼å¼ï¼šç·¨è™Ÿ,æ•™å…·åç¨±</p>
                    </div>
                    
                    <button id="exportBtn" 
                            class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                        ğŸ“¥ åŒ¯å‡ºé»å­˜è¨˜éŒ„
                    </button>
                    
                    <button id="clearRecordsBtn" 
                            class="w-full bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors">
                        ğŸ—‘ï¸ æ¸…ç©ºé»å­˜è¨˜éŒ„
                    </button>

                    <button id="clearAllBtn" 
                            class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                        âŒ æ¸…ç©ºæ‰€æœ‰è³‡æ–™
                    </button>
                </div>
            </section>
        </div>

        <!-- Tools List Section -->
        <section class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <span class="text-2xl mr-2">ğŸ“‹</span>
                    æ•™å…·æ¸…å–®
                </h2>
                <span class="text-sm text-gray-600 dark:text-gray-400">
                    ç¸½è¨ˆï¼š<span id="totalCount" class="font-semibold">0</span> ä»¶
                </span>
            </div>

            <!-- Search -->
            <div class="mb-4">
                <input type="text" id="searchInput" placeholder="æœå°‹æ•™å…·åç¨±æˆ–ç·¨è™Ÿ..." 
                       class="w-full text-base px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
            </div>

            <!-- Tools Table -->
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-100 dark:bg-gray-700">
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">ç·¨è™Ÿ</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">æ•™å…·åç¨±</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">é»å­˜æ¬¡æ•¸</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">æœ€å¾Œé»å­˜æ™‚é–“</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="toolsList">
                        <tr>
                            <td colspan="5" class="border border-gray-300 dark:border-gray-600 px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                å°šç„¡æ•™å…·è³‡æ–™ï¼Œè«‹åŒ¯å…¥CSVæª”æ¡ˆ
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Attendance Records Section -->
        <section class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <span class="text-2xl mr-2">ğŸ“Š</span>
                é»å­˜è¨˜éŒ„
            </h2>

            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-100 dark:bg-gray-700">
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">æ™‚é–“</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">æ•™å…·ç·¨è™Ÿ</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">æ•™å…·åç¨±</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceList">
                        <tr>
                            <td colspan="3" class="border border-gray-300 dark:border-gray-600 px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                å°šç„¡é»å­˜è¨˜éŒ„
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        // === Configuration ===
        const CONFIG = {
            QR_SCANNER_OPTIONS: {
                returnDetailedScanResult: true,
                highlightScanRegion: true,
                highlightCodeOutline: true,
            }
        };

        // === State Management ===
        class AppState {
            constructor() {
                this.tools = [];
                this.attendanceRecords = [];
                this.scanner = null;
                this.isScanning = false;
            }

            // Tools management
            setTools(tools) {
                this.tools = tools;
                this.renderToolsList();
            }

            findTool(id) {
                return this.tools.find(tool => tool.id === id);
            }

            // Attendance management
            addAttendanceRecord(toolId, toolName) {
                const record = {
                    timestamp: new Date().toLocaleString('zh-TW'),
                    toolId: toolId,
                    toolName: toolName
                };
                
                this.attendanceRecords.unshift(record);
                
                // Update tool's attendance count
                const tool = this.findTool(toolId);
                if (tool) {
                    tool.attendanceCount = (tool.attendanceCount || 0) + 1;
                    tool.lastAttendance = record.timestamp;
                }

                this.renderToolsList();
                this.renderAttendanceList();
            }

            clearAttendanceRecords() {
                this.attendanceRecords = [];
                // Reset tools attendance data
                this.tools.forEach(tool => {
                    tool.attendanceCount = 0;
                    tool.lastAttendance = '';
                });
                this.renderToolsList();
                this.renderAttendanceList();
            }

            clearAll() {
                this.tools = [];
                this.attendanceRecords = [];
                this.renderToolsList();
                this.renderAttendanceList();
            }

            // Rendering methods
            renderToolsList(searchTerm = '') {
                ToolsListRenderer.render(this.tools, searchTerm);
            }

            renderAttendanceList() {
                AttendanceRenderer.render(this.attendanceRecords);
            }
        }

        // === QR Scanner Module ===
        class QRScannerModule {
            constructor(appState) {
                this.appState = appState;
                this.scanner = null;
                this.isScanning = false;
                this.cameras = [];
                this.currentCameraIndex = 0;
                this.checkCameraSupport();
                this.setupEventListeners();
            }

            checkCameraSupport() {
                // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´ç›¸æ©Ÿ
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    console.warn('Camera not supported in this environment');
                    this.hideCameraControls();
                    return false;
                }

                // æª¢æŸ¥æ˜¯å¦åœ¨å®‰å…¨ç’°å¢ƒä¸­ (HTTPS or localhost)
                if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                    console.warn('Camera requires HTTPS or localhost');
                    MessageHandler.show('ç›¸æ©ŸåŠŸèƒ½éœ€è¦HTTPSç’°å¢ƒï¼Œè«‹ä½¿ç”¨åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½', 'error');
                    this.hideCameraControls();
                    return false;
                }

                return true;
            }

            hideCameraControls() {
                document.getElementById('cameraSection').style.display = 'none';
                MessageHandler.show('ç•¶å‰ç’°å¢ƒä¸æ”¯æ´ç›¸æ©Ÿï¼Œè«‹ä½¿ç”¨åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½', 'info');
            }

            setupEventListeners() {
                // Camera controls
                document.getElementById('startCameraBtn').addEventListener('click', () => this.startCamera());
                document.getElementById('stopCameraBtn').addEventListener('click', () => this.stopCamera());
                document.getElementById('switchCameraBtn').addEventListener('click', () => this.switchCamera());
            }

            async getCameraDevices() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    this.cameras = devices.filter(device => device.kind === 'videoinput');
                    console.log('Available cameras:', this.cameras.length);
                    return this.cameras;
                } catch (error) {
                    console.error('Failed to enumerate cameras:', error);
                    return [];
                }
            }

            async checkCameraPermission() {
                try {
                    // æª¢æŸ¥ç›¸æ©Ÿæ¬Šé™ç‹€æ…‹
                    const permissionStatus = await navigator.permissions.query({ name: 'camera' });
                    console.log('Camera permission status:', permissionStatus.state);
                    return permissionStatus.state;
                } catch (error) {
                    console.warn('Cannot check camera permission status:', error);
                    return 'unknown';
                }
            }

            async requestCameraPermission() {
                try {
                    // è«‹æ±‚ç›¸æ©Ÿæ¬Šé™ï¼Œä½¿ç”¨åŸºæœ¬è¨­å®šä»¥æé«˜æˆåŠŸç‡
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        } 
                    });
                    
                    // ç«‹å³åœæ­¢æ‰€æœ‰è»Œé“
                    stream.getTracks().forEach(track => {
                        track.stop();
                    });
                    
                    return true;
                } catch (error) {
                    console.error('Permission request failed:', error);
                    throw error;
                }
            }

            async startCamera() {
                if (!this.checkCameraSupport()) {
                    return;
                }

                const startBtn = document.getElementById('startCameraBtn');
                const stopBtn = document.getElementById('stopCameraBtn');
                const switchBtn = document.getElementById('switchCameraBtn');

                try {
                    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                    startBtn.textContent = 'ğŸ“· å•Ÿå‹•ä¸­...';
                    startBtn.disabled = true;

                    // æª¢æŸ¥æ¬Šé™ç‹€æ…‹
                    const permissionState = await this.checkCameraPermission();
                    
                    if (permissionState === 'denied') {
                        throw new Error('Camera permission denied');
                    }

                    // å¦‚æœæ¬Šé™æœªçŸ¥æˆ–éœ€è¦è«‹æ±‚ï¼Œå…ˆè«‹æ±‚æ¬Šé™
                    if (permissionState === 'prompt' || permissionState === 'unknown') {
                        MessageHandler.show('æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...', 'info');
                        await this.requestCameraPermission();
                    }

                    // ç²å–ç›¸æ©Ÿè¨­å‚™åˆ—è¡¨
                    await this.getCameraDevices();

                    const video = document.getElementById('qr-video');
                    const overlay = document.querySelector('.scanner-overlay');

                    // å‰µå»ºQRæƒæå™¨ï¼Œè®“å®ƒè™•ç†ç›¸æ©Ÿå•Ÿå‹•
                    this.scanner = new QrScanner(
                        video,
                        (result) => this.handleScanResult(result),
                        {
                            returnDetailedScanResult: true,
                            highlightScanRegion: true,
                            highlightCodeOutline: true,
                            preferredCamera: 'environment',
                            maxScansPerSecond: 5,
                            highlightScanRegion: true
                        }
                    );

                    // å•Ÿå‹•æƒæå™¨
                    await this.scanner.start();
                    
                    // æ›´æ–°ç•Œé¢
                    video.classList.remove('hidden');
                    overlay.classList.remove('hidden');
                    startBtn.classList.add('hidden');
                    stopBtn.classList.remove('hidden');
                    
                    // åªæœ‰å¤šå€‹ç›¸æ©Ÿæ™‚æ‰é¡¯ç¤ºåˆ‡æ›æŒ‰éˆ•
                    if (this.cameras.length > 1) {
                        switchBtn.classList.remove('hidden');
                    }
                    
                    this.isScanning = true;
                    MessageHandler.show('âœ… ç›¸æ©Ÿå·²å•Ÿå‹•ï¼è«‹å°‡QR codeå°æº–æƒæå€åŸŸ', 'success');
                    
                } catch (error) {
                    console.error('Camera start failed:', error);
                    
                    // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
                    startBtn.textContent = 'ğŸ“· å•Ÿå‹•ç›¸æ©Ÿæƒæ';
                    startBtn.disabled = false;
                    
                    // è©³ç´°éŒ¯èª¤è™•ç†
                    this.handleCameraError(error);
                }
            }

            handleCameraError(error) {
                let errorMessage = 'ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ';
                let showPermissionHelp = false;
                
                if (error.name === 'NotAllowedError' || error.message === 'Camera permission denied') {
                    errorMessage = 'âŒ ç›¸æ©Ÿæ¬Šé™è¢«æ‹’çµ•';
                    showPermissionHelp = true;
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'âŒ æ‰¾ä¸åˆ°å¯ç”¨çš„ç›¸æ©Ÿè¨­å‚™';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'âŒ ç›¸æ©Ÿè¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½”ç”¨ï¼Œè«‹é—œé–‰å…¶ä»–ç›¸æ©Ÿæ‡‰ç”¨';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage = 'âŒ ç›¸æ©Ÿä¸æ”¯æ´æ‰€éœ€çš„è¨­å®š';
                } else if (error.name === 'SecurityError') {
                    errorMessage = 'âŒ å®‰å…¨é™åˆ¶ï¼šéœ€è¦HTTPSç’°å¢ƒ';
                } else if (error.name === 'AbortError') {
                    errorMessage = 'âŒ ç›¸æ©Ÿå•Ÿå‹•è¢«ä¸­æ–·';
                } else {
                    errorMessage = `âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼š${error.message || error.name}`;
                }
                
                MessageHandler.show(errorMessage, 'error');
                
                // é¡¯ç¤ºæ¬Šé™å¹«åŠ©ä¿¡æ¯
                if (showPermissionHelp) {
                    setTimeout(() => {
                        this.showPermissionHelp();
                    }, 1000);
                }
                
                // å¦‚æœæ˜¯åš´é‡éŒ¯èª¤ï¼Œéš±è—ç›¸æ©Ÿæ§åˆ¶é …
                if (error.name === 'NotFoundError' || error.name === 'SecurityError') {
                    setTimeout(() => {
                        this.hideCameraControls();
                    }, 3000);
                }
            }

            showPermissionHelp() {
                const helpMessage = `
                    ğŸ”§ å¦‚ä½•å•Ÿç”¨ç›¸æ©Ÿæ¬Šé™ï¼š
                    
                    Chrome/Edgeï¼š
                    1. é»æ“Šç¶²å€åˆ—å·¦å´çš„é–é ­åœ–ç¤º
                    2. å°‡ç›¸æ©Ÿè¨­ç‚ºã€Œå…è¨±ã€
                    3. é‡æ–°æ•´ç†é é¢
                    
                    Firefoxï¼š
                    1. é»æ“Šç¶²å€åˆ—å·¦å´çš„ç›¾ç‰Œåœ–ç¤º
                    2. é»æ“Šã€Œæ¬Šé™ã€
                    3. å•Ÿç”¨ç›¸æ©Ÿæ¬Šé™
                    
                    Safariï¼š
                    1. åœ¨é¸å–®ä¸­é¸æ“‡ã€Œç¶²ç«™ã€â†’ã€Œç›¸æ©Ÿã€
                    2. é¸æ“‡ã€Œå…è¨±ã€
                `;
                
                // å‰µå»ºå¹«åŠ©å°è©±æ¡†
                this.showCameraHelpDialog(helpMessage);
            }

            showCameraHelpDialog(message) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full">
                        <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">ç›¸æ©Ÿæ¬Šé™è¨­å®šèªªæ˜</h3>
                        <div class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-line mb-6">${message}</div>
                        <div class="flex justify-end space-x-3">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                                é—œé–‰
                            </button>
                            <button onclick="window.location.reload()" 
                                    class="px-4 py-2 bg-primary text-white hover:bg-blue-600 rounded-lg">
                                é‡æ–°æ•´ç†é é¢
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            stopCamera() {
                try {
                    if (this.scanner) {
                        this.scanner.stop();
                        this.scanner.destroy();
                        this.scanner = null;
                    }

                    // Update UI
                    const video = document.getElementById('qr-video');
                    const overlay = document.querySelector('.scanner-overlay');
                    const startBtn = document.getElementById('startCameraBtn');
                    const stopBtn = document.getElementById('stopCameraBtn');
                    const switchBtn = document.getElementById('switchCameraBtn');

                    video.classList.add('hidden');
                    overlay.classList.add('hidden');
                    startBtn.classList.remove('hidden');
                    startBtn.textContent = 'ğŸ“· å•Ÿå‹•ç›¸æ©Ÿæƒæ';
                    startBtn.disabled = false;
                    stopBtn.classList.add('hidden');
                    switchBtn.classList.add('hidden');

                    this.isScanning = false;
                    MessageHandler.show('ç›¸æ©Ÿå·²åœæ­¢', 'info');
                } catch (error) {
                    console.error('Error stopping camera:', error);
                }
            }

            async switchCamera() {
                if (!this.scanner || this.cameras.length <= 1) {
                    return;
                }

                try {
                    this.currentCameraIndex = (this.currentCameraIndex + 1) % this.cameras.length;
                    const currentCamera = this.cameras[this.currentCameraIndex];
                    
                    await this.scanner.setCamera(currentCamera.deviceId);
                    MessageHandler.show(`å·²åˆ‡æ›åˆ°ï¼š${currentCamera.label || 'ç›¸æ©Ÿ ' + (this.currentCameraIndex + 1)}`, 'info');
                } catch (error) {
                    console.error('Switch camera failed:', error);
                    MessageHandler.show('åˆ‡æ›ç›¸æ©Ÿå¤±æ•—', 'error');
                }
            }



            handleScanResult(result) {
                const qrData = typeof result === 'string' ? result : result.data;
                
                // Display result
                document.getElementById('scanResultText').textContent = qrData;
                document.getElementById('scanResult').classList.remove('hidden');
                
                // Process the scan
                AttendanceProcessor.process(qrData.trim(), this.appState);
            }
        }

        // === CSV Module ===
        class CSVModule {
            constructor(appState) {
                this.appState = appState;
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('csvInput').addEventListener('change', (e) => this.handleImport(e));
                document.getElementById('exportBtn').addEventListener('click', () => this.exportAttendance());
                document.getElementById('clearRecordsBtn').addEventListener('click', () => this.clearRecords());
                document.getElementById('clearAllBtn').addEventListener('click', () => this.clearAll());
            }

            handleImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                const fileName = file.name.toLowerCase();
                const fileExtension = fileName.split('.').pop();

                if (fileExtension === 'csv') {
                    this.parseCSV(file);
                } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                    this.parseExcel(file);
                } else {
                    MessageHandler.show('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼Œè«‹ä½¿ç”¨ CSV æˆ– Excel æª”æ¡ˆ', 'error');
                }
            }

            parseCSV(file) {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        if (results.errors.length > 0) {
                            MessageHandler.show('CSVæª”æ¡ˆæ ¼å¼éŒ¯èª¤', 'error');
                            console.error('CSV parse errors:', results.errors);
                            return;
                        }

                        const tools = this.processImportData(results.data);
                        this.appState.setTools(tools);
                        MessageHandler.show(`âœ… æˆåŠŸåŒ¯å…¥ ${tools.length} ä»¶æ•™å…· (CSVæ ¼å¼)`, 'success');
                    },
                    error: (error) => {
                        console.error('CSV parse error:', error);
                        MessageHandler.show('è®€å–CSVæª”æ¡ˆå¤±æ•—', 'error');
                    }
                });
            }

            parseExcel(file) {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        
                        // è®€å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // è½‰æ›ç‚ºJSONæ ¼å¼
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            MessageHandler.show('Excelæª”æ¡ˆå…§å®¹ä¸è¶³ï¼Œè«‹ç¢ºèªæœ‰æ¨™é¡Œåˆ—å’Œè³‡æ–™åˆ—', 'error');
                            return;
                        }

                        // å°‡é™£åˆ—æ ¼å¼è½‰æ›ç‚ºç‰©ä»¶æ ¼å¼
                        const headers = jsonData[0];
                        const rows = jsonData.slice(1);
                        
                        const objectData = rows.map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[header] = row[index] || '';
                            });
                            return obj;
                        });

                        const tools = this.processImportData(objectData);
                        this.appState.setTools(tools);
                        MessageHandler.show(`âœ… æˆåŠŸåŒ¯å…¥ ${tools.length} ä»¶æ•™å…· (Excelæ ¼å¼)`, 'success');
                        
                    } catch (error) {
                        console.error('Excel parse error:', error);
                        MessageHandler.show('è®€å–Excelæª”æ¡ˆå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º', 'error');
                    }
                };
                
                reader.onerror = () => {
                    MessageHandler.show('æª”æ¡ˆè®€å–å¤±æ•—', 'error');
                };
                
                reader.readAsBinaryString(file);
            }

            processImportData(data) {
                return data
                    .map(row => {
                        // æ”¯æ´å¤šç¨®æ¬„ä½åç¨±
                        const id = (
                            row['ç·¨è™Ÿ'] || row['ç¼–å·'] || row['ID'] || row['id'] || 
                            row['æ•™å…·ç·¨è™Ÿ'] || row['æ•™å…·ç¼–å·'] || row['Tool ID'] || row['ToolID'] ||
                            row['ä»£ç¢¼'] || row['ä»£ç '] || row['Code'] || row['code'] || ''
                        ).toString().trim();

                        const name = (
                            row['æ•™å…·åç¨±'] || row['æ•™å…·åç§°'] || row['åç¨±'] || row['åç§°'] || 
                            row['Name'] || row['name'] || row['Tool Name'] || row['ToolName'] ||
                            row['å“å'] || row['ç‰©å“'] || row['Item'] || row['item'] || ''
                        ).toString().trim();

                        return {
                            id: id,
                            name: name,
                            attendanceCount: 0,
                            lastAttendance: ''
                        };
                    })
                    .filter(tool => tool.id && tool.name); // éæ¿¾æ‰ç©ºç™½è³‡æ–™
            }

            exportAttendance() {
                if (this.appState.attendanceRecords.length === 0) {
                    MessageHandler.show('æ²’æœ‰é»å­˜è¨˜éŒ„å¯ä»¥åŒ¯å‡º', 'error');
                    return;
                }

                const csvData = this.appState.attendanceRecords.map(record => ({
                    æ™‚é–“: record.timestamp,
                    æ•™å…·ç·¨è™Ÿ: record.toolId,
                    æ•™å…·åç¨±: record.toolName
                }));

                const csv = Papa.unparse(csvData);
                this.downloadCSV(csv, `é»å­˜è¨˜éŒ„_${new Date().toISOString().split('T')[0]}.csv`);
                MessageHandler.show('é»å­˜è¨˜éŒ„å·²ä¸‹è¼‰', 'success');
            }

            clearRecords() {
                if (this.showConfirmDialog('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰é»å­˜è¨˜éŒ„å—ï¼Ÿæ•™å…·æ¸…å–®å°‡ä¿ç•™ã€‚')) {
                    this.appState.clearAttendanceRecords();
                    MessageHandler.show('é»å­˜è¨˜éŒ„å·²æ¸…ç©º', 'success');
                }
            }

            clearAll() {
                if (this.showConfirmDialog('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                    this.appState.clearAll();
                    MessageHandler.show('æ‰€æœ‰è³‡æ–™å·²æ¸…ç©º', 'success');
                }
            }

            downloadCSV(csvContent, filename) {
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            showConfirmDialog(message) {
                return confirm(message);
            }
        }

        // === Attendance Processor ===
        class AttendanceProcessor {
            static process(qrData, appState) {
                const toolId = qrData;
                const tool = appState.findTool(toolId);

                if (tool) {
                    appState.addAttendanceRecord(toolId, tool.name);
                    MessageHandler.show(`âœ… ${tool.name} é»å­˜æˆåŠŸ`, 'success');
                } else {
                    MessageHandler.show(`âŒ æ‰¾ä¸åˆ°ç·¨è™Ÿç‚º "${toolId}" çš„æ•™å…·`, 'error');
                }
            }
        }

        // === Renderers ===
        class ToolsListRenderer {
            static render(tools, searchTerm = '') {
                const toolsList = document.getElementById('toolsList');
                const totalCount = document.getElementById('totalCount');

                let filteredTools = tools;
                if (searchTerm) {
                    filteredTools = tools.filter(tool => 
                        tool.id.toLowerCase().includes(searchTerm.toLowerCase()) || 
                        tool.name.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }

                totalCount.textContent = filteredTools.length;

                if (filteredTools.length === 0) {
                    toolsList.innerHTML = `
                        <tr>
                            <td colspan="5" class="border border-gray-300 dark:border-gray-600 px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                ${searchTerm ? 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ•™å…·' : 'å°šç„¡æ•™å…·è³‡æ–™ï¼Œè«‹åŒ¯å…¥CSVæª”æ¡ˆ'}
                            </td>
                        </tr>
                    `;
                    return;
                }

                toolsList.innerHTML = filteredTools.map(tool => `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3 font-mono">${tool.id}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3">${tool.name}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-center">
                            <span class="px-2 py-1 rounded-full text-sm font-medium ${
                                (tool.attendanceCount || 0) > 0 ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400' : 
                                'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'
                            }">
                                ${tool.attendanceCount || 0}
                            </span>
                        </td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-sm">
                            ${tool.lastAttendance || '-'}
                        </td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3">
                            <button onclick="attendanceProcessor.process('${tool.id}', appState)" 
                                    class="bg-primary text-white px-3 py-1 rounded text-xs hover:bg-blue-600 transition-colors">
                                ğŸ“ æ‰‹å‹•é»å­˜
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        class AttendanceRenderer {
            static render(records) {
                const attendanceList = document.getElementById('attendanceList');

                if (records.length === 0) {
                    attendanceList.innerHTML = `
                        <tr>
                            <td colspan="3" class="border border-gray-300 dark:border-gray-600 px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                å°šç„¡é»å­˜è¨˜éŒ„
                            </td>
                        </tr>
                    `;
                    return;
                }

                attendanceList.innerHTML = records.slice(0, 20).map(record => `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-sm">${record.timestamp}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3 font-mono">${record.toolId}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3">${record.toolName}</td>
                    </tr>
                `).join('');
            }
        }

        // === Message Handler ===
        class MessageHandler {
            static show(message, type = 'info') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 shadow-lg ${
                    type === 'success' ? 'bg-green-500' :
                    type === 'error' ? 'bg-red-500' : 'bg-blue-500'
                }`;
                messageDiv.textContent = message;
                
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 3000);
            }
        }

        // === Theme Management ===
        function initializeTheme() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
        }

        // === Search Functionality ===
        function setupSearch(appState) {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value;
                appState.renderToolsList(searchTerm);
            });
        }

        // === Application Initialization ===
        let appState;
        let qrScannerModule;
        let csvModule;
        let attendanceProcessor;

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize theme
            initializeTheme();
            
            // Initialize application state
            appState = new AppState();
            
            // Initialize modules
            qrScannerModule = new QRScannerModule(appState);
            csvModule = new CSVModule(appState);
            attendanceProcessor = AttendanceProcessor;
            
            // Setup search
            setupSearch(appState);
            
            // Load sample data for demonstration
            loadSampleData();
            
            console.log('ğŸ“‹ æ•™å…·é»å­˜ç³»çµ±å·²åˆå§‹åŒ–');
        });

        // === Sample Data ===
        function loadSampleData() {
            if (appState.tools.length === 0) {
                const sampleTools = [
                    { id: 'T001', name: 'é¡¯å¾®é¡', attendanceCount: 0, lastAttendance: '' },
                    { id: 'T002', name: 'æŠ•å½±æ©Ÿ', attendanceCount: 0, lastAttendance: '' },
                    { id: 'T003', name: 'æ•¸å­¸æ•™å…·çµ„', attendanceCount: 0, lastAttendance: '' },
                    { id: 'T004', name: 'é«”æ„Ÿå™¨æ', attendanceCount: 0, lastAttendance: '' }
                ];
                appState.setTools(sampleTools);
            }
        }
    </script>
</body>
</html>
