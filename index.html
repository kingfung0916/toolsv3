<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教具點存系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#f3f4f6'
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <style>
        /* QR Scanner Styles */
        #qr-video {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 8px;
            display: block;
            margin: 0 auto;
        }
        
        .scanner-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            min-height: 300px;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid #5D5CDE;
            border-radius: 12px;
            pointer-events: none;
            z-index: 10;
        }

        .scanner-overlay::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border: 3px solid rgba(93, 92, 222, 0.3);
            border-radius: 12px;
            animation: scanner-pulse 2s infinite;
        }

        @keyframes scanner-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .camera-instructions {
            text-align: center;
            padding: 20px;
            background: rgba(93, 92, 222, 0.1);
            border-radius: 8px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
    <!-- Main Container -->
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-primary mb-2">📋 教具點存系統</h1>
            <p class="text-gray-600 dark:text-gray-400">掃描QR code進行教具點存管理</p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid lg:grid-cols-2 gap-6 mb-8">
            <!-- QR Scanner Section -->
            <section class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold flex items-center">
                        <span class="text-2xl mr-2">📱</span>
                        QR Code 掃描
                    </h2>
                    <button id="switchCameraBtn" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600 hidden">
                        切換相機
                    </button>
                </div>
                
                <!-- Camera Scanner -->
                <div id="cameraSection" class="mb-4">
                    <div class="scanner-container text-center mb-4">
                        <video id="qr-video" class="hidden"></video>
                        <div class="scanner-overlay hidden"></div>
                    </div>
                    <div class="flex justify-center space-x-3">
                        <button id="startCameraBtn" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            📷 啟動相機掃描
                        </button>
                        <button id="stopCameraBtn" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors hidden">
                            ⏹️ 停止掃描
                        </button>
                    </div>
                </div>

                <!-- Camera Instructions -->
                <div class="camera-instructions" id="cameraInstructions">
                    <div class="text-lg font-medium mb-2">📷 使用說明</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        <p>1. 點擊「啟動相機掃描」開始使用</p>
                        <p>2. 將教具上的QR code對準掃描框</p>
                        <p>3. 系統會自動識別並記錄點存</p>
                    </div>
                </div>

                <!-- Scan Result -->
                <div id="scanResult" class="hidden mt-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
                    <h3 class="font-semibold text-green-800 dark:text-green-400 mb-2">掃描結果：</h3>
                    <p id="scanResultText" class="text-green-700 dark:text-green-300 break-all"></p>
                </div>
            </section>

            <!-- CSV Management Section -->
            <section class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="text-2xl mr-2">📄</span>
                    CSV 資料管理
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">匯入教具清單</label>
                        <input type="file" id="csvInput" accept=".csv,.xlsx,.xls" 
                               class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">支援格式：CSV、Excel (.xlsx/.xls)</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">格式：編號,教具名稱</p>
                    </div>
                    
                    <button id="exportBtn" 
                            class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                        📥 匯出點存記錄
                    </button>
                    
                    <button id="clearRecordsBtn" 
                            class="w-full bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors">
                        🗑️ 清空點存記錄
                    </button>

                    <button id="clearAllBtn" 
                            class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                        ❌ 清空所有資料
                    </button>
                </div>
            </section>
        </div>

        <!-- Tools List Section -->
        <section class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <span class="text-2xl mr-2">📋</span>
                    教具清單
                </h2>
                <span class="text-sm text-gray-600 dark:text-gray-400">
                    總計：<span id="totalCount" class="font-semibold">0</span> 件
                </span>
            </div>

            <!-- Search -->
            <div class="mb-4">
                <input type="text" id="searchInput" placeholder="搜尋教具名稱或編號..." 
                       class="w-full text-base px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
            </div>

            <!-- Tools Table -->
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-100 dark:bg-gray-700">
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">編號</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">教具名稱</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">點存次數</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">最後點存時間</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">操作</th>
                        </tr>
                    </thead>
                    <tbody id="toolsList">
                        <tr>
                            <td colspan="5" class="border border-gray-300 dark:border-gray-600 px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                尚無教具資料，請匯入CSV檔案
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Attendance Records Section -->
        <section class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <span class="text-2xl mr-2">📊</span>
                點存記錄
            </h2>

            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-100 dark:bg-gray-700">
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">時間</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">教具編號</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">教具名稱</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceList">
                        <tr>
                            <td colspan="3" class="border border-gray-300 dark:border-gray-600 px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                尚無點存記錄
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        // === Configuration ===
        const CONFIG = {
            QR_SCANNER_OPTIONS: {
                returnDetailedScanResult: true,
                highlightScanRegion: true,
                highlightCodeOutline: true,
            }
        };

        // === State Management ===
        class AppState {
            constructor() {
                this.tools = [];
                this.attendanceRecords = [];
                this.scanner = null;
                this.isScanning = false;
            }

            // Tools management
            setTools(tools) {
                this.tools = tools;
                this.renderToolsList();
            }

            findTool(id) {
                return this.tools.find(tool => tool.id === id);
            }

            // Attendance management
            addAttendanceRecord(toolId, toolName) {
                const record = {
                    timestamp: new Date().toLocaleString('zh-TW'),
                    toolId: toolId,
                    toolName: toolName
                };
                
                this.attendanceRecords.unshift(record);
                
                // Update tool's attendance count
                const tool = this.findTool(toolId);
                if (tool) {
                    tool.attendanceCount = (tool.attendanceCount || 0) + 1;
                    tool.lastAttendance = record.timestamp;
                }

                this.renderToolsList();
                this.renderAttendanceList();
            }

            clearAttendanceRecords() {
                this.attendanceRecords = [];
                // Reset tools attendance data
                this.tools.forEach(tool => {
                    tool.attendanceCount = 0;
                    tool.lastAttendance = '';
                });
                this.renderToolsList();
                this.renderAttendanceList();
            }

            clearAll() {
                this.tools = [];
                this.attendanceRecords = [];
                this.renderToolsList();
                this.renderAttendanceList();
            }

            // Rendering methods
            renderToolsList(searchTerm = '') {
                ToolsListRenderer.render(this.tools, searchTerm);
            }

            renderAttendanceList() {
                AttendanceRenderer.render(this.attendanceRecords);
            }
        }

        // === QR Scanner Module ===
        class QRScannerModule {
            constructor(appState) {
                this.appState = appState;
                this.scanner = null;
                this.isScanning = false;
                this.cameras = [];
                this.currentCameraIndex = 0;
                this.checkCameraSupport();
                this.setupEventListeners();
            }

            checkCameraSupport() {
                // 檢查瀏覽器是否支援相機
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    console.warn('Camera not supported in this environment');
                    this.hideCameraControls();
                    return false;
                }

                // 檢查是否在安全環境中 (HTTPS or localhost)
                if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                    console.warn('Camera requires HTTPS or localhost');
                    MessageHandler.show('相機功能需要HTTPS環境，請使用圖片上傳功能', 'error');
                    this.hideCameraControls();
                    return false;
                }

                return true;
            }

            hideCameraControls() {
                document.getElementById('cameraSection').style.display = 'none';
                MessageHandler.show('當前環境不支援相機，請使用圖片上傳功能', 'info');
            }

            setupEventListeners() {
                // Camera controls
                document.getElementById('startCameraBtn').addEventListener('click', () => this.startCamera());
                document.getElementById('stopCameraBtn').addEventListener('click', () => this.stopCamera());
                document.getElementById('switchCameraBtn').addEventListener('click', () => this.switchCamera());
            }

            async getCameraDevices() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    this.cameras = devices.filter(device => device.kind === 'videoinput');
                    console.log('Available cameras:', this.cameras.length);
                    return this.cameras;
                } catch (error) {
                    console.error('Failed to enumerate cameras:', error);
                    return [];
                }
            }

            async checkCameraPermission() {
                try {
                    // 檢查相機權限狀態
                    const permissionStatus = await navigator.permissions.query({ name: 'camera' });
                    console.log('Camera permission status:', permissionStatus.state);
                    return permissionStatus.state;
                } catch (error) {
                    console.warn('Cannot check camera permission status:', error);
                    return 'unknown';
                }
            }

            async requestCameraPermission() {
                try {
                    // 請求相機權限，使用基本設定以提高成功率
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        } 
                    });
                    
                    // 立即停止所有軌道
                    stream.getTracks().forEach(track => {
                        track.stop();
                    });
                    
                    return true;
                } catch (error) {
                    console.error('Permission request failed:', error);
                    throw error;
                }
            }

            async startCamera() {
                if (!this.checkCameraSupport()) {
                    return;
                }

                const startBtn = document.getElementById('startCameraBtn');
                const stopBtn = document.getElementById('stopCameraBtn');
                const switchBtn = document.getElementById('switchCameraBtn');

                try {
                    // 顯示載入狀態
                    startBtn.textContent = '📷 啟動中...';
                    startBtn.disabled = true;

                    // 檢查權限狀態
                    const permissionState = await this.checkCameraPermission();
                    
                    if (permissionState === 'denied') {
                        throw new Error('Camera permission denied');
                    }

                    // 如果權限未知或需要請求，先請求權限
                    if (permissionState === 'prompt' || permissionState === 'unknown') {
                        MessageHandler.show('正在請求相機權限...', 'info');
                        await this.requestCameraPermission();
                    }

                    // 獲取相機設備列表
                    await this.getCameraDevices();

                    const video = document.getElementById('qr-video');
                    const overlay = document.querySelector('.scanner-overlay');

                    // 創建QR掃描器，讓它處理相機啟動
                    this.scanner = new QrScanner(
                        video,
                        (result) => this.handleScanResult(result),
                        {
                            returnDetailedScanResult: true,
                            highlightScanRegion: true,
                            highlightCodeOutline: true,
                            preferredCamera: 'environment',
                            maxScansPerSecond: 5,
                            highlightScanRegion: true
                        }
                    );

                    // 啟動掃描器
                    await this.scanner.start();
                    
                    // 更新界面
                    video.classList.remove('hidden');
                    overlay.classList.remove('hidden');
                    startBtn.classList.add('hidden');
                    stopBtn.classList.remove('hidden');
                    
                    // 只有多個相機時才顯示切換按鈕
                    if (this.cameras.length > 1) {
                        switchBtn.classList.remove('hidden');
                    }
                    
                    this.isScanning = true;
                    MessageHandler.show('✅ 相機已啟動！請將QR code對準掃描區域', 'success');
                    
                } catch (error) {
                    console.error('Camera start failed:', error);
                    
                    // 重置按鈕狀態
                    startBtn.textContent = '📷 啟動相機掃描';
                    startBtn.disabled = false;
                    
                    // 詳細錯誤處理
                    this.handleCameraError(error);
                }
            }

            handleCameraError(error) {
                let errorMessage = '無法啟動相機';
                let showPermissionHelp = false;
                
                if (error.name === 'NotAllowedError' || error.message === 'Camera permission denied') {
                    errorMessage = '❌ 相機權限被拒絕';
                    showPermissionHelp = true;
                } else if (error.name === 'NotFoundError') {
                    errorMessage = '❌ 找不到可用的相機設備';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = '❌ 相機被其他應用程式佔用，請關閉其他相機應用';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage = '❌ 相機不支援所需的設定';
                } else if (error.name === 'SecurityError') {
                    errorMessage = '❌ 安全限制：需要HTTPS環境';
                } else if (error.name === 'AbortError') {
                    errorMessage = '❌ 相機啟動被中斷';
                } else {
                    errorMessage = `❌ 相機啟動失敗：${error.message || error.name}`;
                }
                
                MessageHandler.show(errorMessage, 'error');
                
                // 顯示權限幫助信息
                if (showPermissionHelp) {
                    setTimeout(() => {
                        this.showPermissionHelp();
                    }, 1000);
                }
                
                // 如果是嚴重錯誤，隱藏相機控制項
                if (error.name === 'NotFoundError' || error.name === 'SecurityError') {
                    setTimeout(() => {
                        this.hideCameraControls();
                    }, 3000);
                }
            }

            showPermissionHelp() {
                const helpMessage = `
                    🔧 如何啟用相機權限：
                    
                    Chrome/Edge：
                    1. 點擊網址列左側的鎖頭圖示
                    2. 將相機設為「允許」
                    3. 重新整理頁面
                    
                    Firefox：
                    1. 點擊網址列左側的盾牌圖示
                    2. 點擊「權限」
                    3. 啟用相機權限
                    
                    Safari：
                    1. 在選單中選擇「網站」→「相機」
                    2. 選擇「允許」
                `;
                
                // 創建幫助對話框
                this.showCameraHelpDialog(helpMessage);
            }

            showCameraHelpDialog(message) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full">
                        <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">相機權限設定說明</h3>
                        <div class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-line mb-6">${message}</div>
                        <div class="flex justify-end space-x-3">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                                關閉
                            </button>
                            <button onclick="window.location.reload()" 
                                    class="px-4 py-2 bg-primary text-white hover:bg-blue-600 rounded-lg">
                                重新整理頁面
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            stopCamera() {
                try {
                    if (this.scanner) {
                        this.scanner.stop();
                        this.scanner.destroy();
                        this.scanner = null;
                    }

                    // Update UI
                    const video = document.getElementById('qr-video');
                    const overlay = document.querySelector('.scanner-overlay');
                    const startBtn = document.getElementById('startCameraBtn');
                    const stopBtn = document.getElementById('stopCameraBtn');
                    const switchBtn = document.getElementById('switchCameraBtn');

                    video.classList.add('hidden');
                    overlay.classList.add('hidden');
                    startBtn.classList.remove('hidden');
                    startBtn.textContent = '📷 啟動相機掃描';
                    startBtn.disabled = false;
                    stopBtn.classList.add('hidden');
                    switchBtn.classList.add('hidden');

                    this.isScanning = false;
                    MessageHandler.show('相機已停止', 'info');
                } catch (error) {
                    console.error('Error stopping camera:', error);
                }
            }

            async switchCamera() {
                if (!this.scanner || this.cameras.length <= 1) {
                    return;
                }

                try {
                    this.currentCameraIndex = (this.currentCameraIndex + 1) % this.cameras.length;
                    const currentCamera = this.cameras[this.currentCameraIndex];
                    
                    await this.scanner.setCamera(currentCamera.deviceId);
                    MessageHandler.show(`已切換到：${currentCamera.label || '相機 ' + (this.currentCameraIndex + 1)}`, 'info');
                } catch (error) {
                    console.error('Switch camera failed:', error);
                    MessageHandler.show('切換相機失敗', 'error');
                }
            }



            handleScanResult(result) {
                const qrData = typeof result === 'string' ? result : result.data;
                
                // Display result
                document.getElementById('scanResultText').textContent = qrData;
                document.getElementById('scanResult').classList.remove('hidden');
                
                // Process the scan
                AttendanceProcessor.process(qrData.trim(), this.appState);
            }
        }

        // === CSV Module ===
        class CSVModule {
            constructor(appState) {
                this.appState = appState;
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('csvInput').addEventListener('change', (e) => this.handleImport(e));
                document.getElementById('exportBtn').addEventListener('click', () => this.exportAttendance());
                document.getElementById('clearRecordsBtn').addEventListener('click', () => this.clearRecords());
                document.getElementById('clearAllBtn').addEventListener('click', () => this.clearAll());
            }

            handleImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                const fileName = file.name.toLowerCase();
                const fileExtension = fileName.split('.').pop();

                if (fileExtension === 'csv') {
                    this.parseCSV(file);
                } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                    this.parseExcel(file);
                } else {
                    MessageHandler.show('不支援的檔案格式，請使用 CSV 或 Excel 檔案', 'error');
                }
            }

            parseCSV(file) {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        if (results.errors.length > 0) {
                            MessageHandler.show('CSV檔案格式錯誤', 'error');
                            console.error('CSV parse errors:', results.errors);
                            return;
                        }

                        const tools = this.processImportData(results.data);
                        this.appState.setTools(tools);
                        MessageHandler.show(`✅ 成功匯入 ${tools.length} 件教具 (CSV格式)`, 'success');
                    },
                    error: (error) => {
                        console.error('CSV parse error:', error);
                        MessageHandler.show('讀取CSV檔案失敗', 'error');
                    }
                });
            }

            parseExcel(file) {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        
                        // 讀取第一個工作表
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // 轉換為JSON格式
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            MessageHandler.show('Excel檔案內容不足，請確認有標題列和資料列', 'error');
                            return;
                        }

                        // 將陣列格式轉換為物件格式
                        const headers = jsonData[0];
                        const rows = jsonData.slice(1);
                        
                        const objectData = rows.map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[header] = row[index] || '';
                            });
                            return obj;
                        });

                        const tools = this.processImportData(objectData);
                        this.appState.setTools(tools);
                        MessageHandler.show(`✅ 成功匯入 ${tools.length} 件教具 (Excel格式)`, 'success');
                        
                    } catch (error) {
                        console.error('Excel parse error:', error);
                        MessageHandler.show('讀取Excel檔案失敗，請確認檔案格式正確', 'error');
                    }
                };
                
                reader.onerror = () => {
                    MessageHandler.show('檔案讀取失敗', 'error');
                };
                
                reader.readAsBinaryString(file);
            }

            processImportData(data) {
                return data
                    .map(row => {
                        // 支援多種欄位名稱
                        const id = (
                            row['編號'] || row['编号'] || row['ID'] || row['id'] || 
                            row['教具編號'] || row['教具编号'] || row['Tool ID'] || row['ToolID'] ||
                            row['代碼'] || row['代码'] || row['Code'] || row['code'] || ''
                        ).toString().trim();

                        const name = (
                            row['教具名稱'] || row['教具名称'] || row['名稱'] || row['名称'] || 
                            row['Name'] || row['name'] || row['Tool Name'] || row['ToolName'] ||
                            row['品名'] || row['物品'] || row['Item'] || row['item'] || ''
                        ).toString().trim();

                        return {
                            id: id,
                            name: name,
                            attendanceCount: 0,
                            lastAttendance: ''
                        };
                    })
                    .filter(tool => tool.id && tool.name); // 過濾掉空白資料
            }

            exportAttendance() {
                if (this.appState.attendanceRecords.length === 0) {
                    MessageHandler.show('沒有點存記錄可以匯出', 'error');
                    return;
                }

                const csvData = this.appState.attendanceRecords.map(record => ({
                    時間: record.timestamp,
                    教具編號: record.toolId,
                    教具名稱: record.toolName
                }));

                const csv = Papa.unparse(csvData);
                this.downloadCSV(csv, `點存記錄_${new Date().toISOString().split('T')[0]}.csv`);
                MessageHandler.show('點存記錄已下載', 'success');
            }

            clearRecords() {
                if (this.showConfirmDialog('確定要清空所有點存記錄嗎？教具清單將保留。')) {
                    this.appState.clearAttendanceRecords();
                    MessageHandler.show('點存記錄已清空', 'success');
                }
            }

            clearAll() {
                if (this.showConfirmDialog('確定要清空所有資料嗎？此操作無法復原。')) {
                    this.appState.clearAll();
                    MessageHandler.show('所有資料已清空', 'success');
                }
            }

            downloadCSV(csvContent, filename) {
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            showConfirmDialog(message) {
                return confirm(message);
            }
        }

        // === Attendance Processor ===
        class AttendanceProcessor {
            static process(qrData, appState) {
                const toolId = qrData;
                const tool = appState.findTool(toolId);

                if (tool) {
                    appState.addAttendanceRecord(toolId, tool.name);
                    MessageHandler.show(`✅ ${tool.name} 點存成功`, 'success');
                } else {
                    MessageHandler.show(`❌ 找不到編號為 "${toolId}" 的教具`, 'error');
                }
            }
        }

        // === Renderers ===
        class ToolsListRenderer {
            static render(tools, searchTerm = '') {
                const toolsList = document.getElementById('toolsList');
                const totalCount = document.getElementById('totalCount');

                let filteredTools = tools;
                if (searchTerm) {
                    filteredTools = tools.filter(tool => 
                        tool.id.toLowerCase().includes(searchTerm.toLowerCase()) || 
                        tool.name.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }

                totalCount.textContent = filteredTools.length;

                if (filteredTools.length === 0) {
                    toolsList.innerHTML = `
                        <tr>
                            <td colspan="5" class="border border-gray-300 dark:border-gray-600 px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                ${searchTerm ? '找不到符合條件的教具' : '尚無教具資料，請匯入CSV檔案'}
                            </td>
                        </tr>
                    `;
                    return;
                }

                toolsList.innerHTML = filteredTools.map(tool => `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3 font-mono">${tool.id}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3">${tool.name}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-center">
                            <span class="px-2 py-1 rounded-full text-sm font-medium ${
                                (tool.attendanceCount || 0) > 0 ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400' : 
                                'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'
                            }">
                                ${tool.attendanceCount || 0}
                            </span>
                        </td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-sm">
                            ${tool.lastAttendance || '-'}
                        </td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3">
                            <button onclick="attendanceProcessor.process('${tool.id}', appState)" 
                                    class="bg-primary text-white px-3 py-1 rounded text-xs hover:bg-blue-600 transition-colors">
                                📝 手動點存
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        class AttendanceRenderer {
            static render(records) {
                const attendanceList = document.getElementById('attendanceList');

                if (records.length === 0) {
                    attendanceList.innerHTML = `
                        <tr>
                            <td colspan="3" class="border border-gray-300 dark:border-gray-600 px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                尚無點存記錄
                            </td>
                        </tr>
                    `;
                    return;
                }

                attendanceList.innerHTML = records.slice(0, 20).map(record => `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-sm">${record.timestamp}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3 font-mono">${record.toolId}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3">${record.toolName}</td>
                    </tr>
                `).join('');
            }
        }

        // === Message Handler ===
        class MessageHandler {
            static show(message, type = 'info') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 shadow-lg ${
                    type === 'success' ? 'bg-green-500' :
                    type === 'error' ? 'bg-red-500' : 'bg-blue-500'
                }`;
                messageDiv.textContent = message;
                
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 3000);
            }
        }

        // === Theme Management ===
        function initializeTheme() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
        }

        // === Search Functionality ===
        function setupSearch(appState) {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value;
                appState.renderToolsList(searchTerm);
            });
        }

        // === Application Initialization ===
        let appState;
        let qrScannerModule;
        let csvModule;
        let attendanceProcessor;

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize theme
            initializeTheme();
            
            // Initialize application state
            appState = new AppState();
            
            // Initialize modules
            qrScannerModule = new QRScannerModule(appState);
            csvModule = new CSVModule(appState);
            attendanceProcessor = AttendanceProcessor;
            
            // Setup search
            setupSearch(appState);
            
            // Load sample data for demonstration
            loadSampleData();
            
            console.log('📋 教具點存系統已初始化');
        });

        // === Sample Data ===
        function loadSampleData() {
            if (appState.tools.length === 0) {
                const sampleTools = [
                    { id: 'T001', name: '顯微鏡', attendanceCount: 0, lastAttendance: '' },
                    { id: 'T002', name: '投影機', attendanceCount: 0, lastAttendance: '' },
                    { id: 'T003', name: '數學教具組', attendanceCount: 0, lastAttendance: '' },
                    { id: 'T004', name: '體感器材', attendanceCount: 0, lastAttendance: '' }
                ];
                appState.setTools(sampleTools);
            }
        }
    </script>
</body>
</html>
